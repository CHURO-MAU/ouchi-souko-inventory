<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="シンプルで使いやすい日用品の在庫管理アプリ。消費予測機能で買い忘れを防止します。">
    <meta name="theme-color" content="#6b8e7c">
    <title>おうち倉庫</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS用のメタタグ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="おうち倉庫">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-192x192.png">

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>🏠 おうち倉庫</h1>
        </header>

        <div id="warning-banner" class="warning-banner hidden"></div>

        <div class="add-item-section">
            <h2>新しい日用品を追加</h2>
            <form id="add-item-form">
                <div class="form-group">
                    <label for="item-name">商品名</label>
                    <div class="input-with-search">
                        <input type="text" id="item-name" placeholder="例: トイレットペーパー" required>
                        <button type="button" class="btn-search btn-search-amazon" id="search-amazon">🔍 Amazon</button>
                        <button type="button" class="btn-search btn-search-rakuten" id="search-rakuten">🔍 楽天</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="item-quantity">在庫数</label>
                    <input type="number" id="item-quantity" min="0" placeholder="例: 10" required>
                </div>
                <div class="form-group">
                    <label for="item-min-quantity">最低在庫数</label>
                    <input type="number" id="item-min-quantity" min="0" placeholder="例: 3" required>
                </div>
                <div class="form-group">
                    <label for="item-price">参考価格（任意）</label>
                    <input type="number" id="item-price" min="0" step="0.01" placeholder="例: 500">
                </div>
                <div class="form-group">
                    <label for="item-category">カテゴリ</label>
                    <select id="item-category">
                        <option value="日用品">日用品</option>
                        <option value="食品">食品</option>
                        <option value="洗剤">洗剤</option>
                        <option value="衛生用品">衛生用品</option>
                        <option value="その他">その他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="item-amazon-link">Amazonリンク（任意）
                        <span class="label-hint">上の検索ボタンから商品を選んでURLを貼り付け</span>
                    </label>
                    <input type="url" id="item-amazon-link" placeholder="https://www.amazon.co.jp/...">
                </div>
                <div class="form-group">
                    <label for="item-rakuten-link">楽天リンク（任意）
                        <span class="label-hint">上の検索ボタンから商品を選んでURLを貼り付け</span>
                    </label>
                    <input type="url" id="item-rakuten-link" placeholder="https://item.rakuten.co.jp/...">
                </div>
                <button type="submit" class="btn btn-primary">追加</button>
            </form>
        </div>

        <div class="filter-section">
            <h2>在庫一覧</h2>
            <div class="filter-controls">
                <select id="category-filter">
                    <option value="all">すべてのカテゴリ</option>
                    <option value="日用品">日用品</option>
                    <option value="食品">食品</option>
                    <option value="洗剤">洗剤</option>
                    <option value="衛生用品">衛生用品</option>
                    <option value="その他">その他</option>
                </select>
                <label class="checkbox-label">
                    <input type="checkbox" id="low-stock-filter">
                    在庫不足のみ表示
                </label>
            </div>
        </div>

        <div id="inventory-list" class="inventory-list">
            <!-- アイテムがここに動的に追加されます -->
        </div>

        <div id="empty-state" class="empty-state">
            <p>まだ日用品が登録されていません。上のフォームから追加してください。</p>
        </div>
    </div>

    <script src="app.js"></script>

    <!-- Service Worker登録 -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('✅ Service Worker registered:', registration.scope);

                        // 新しいService Workerが利用可能になったときの処理
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // 新しいバージョンが利用可能
                                    console.log('🔄 New version available! Please refresh.');
                                    if (confirm('新しいバージョンが利用可能です。更新しますか？')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('❌ Service Worker registration failed:', error);
                    });

                // Service Workerの更新をチェック
                navigator.serviceWorker.ready.then((registration) => {
                    registration.update();
                });
            });

            // ページがService Workerによって制御されるようになったときにリロード
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload();
                }
            });
        } else {
            console.warn('⚠️ Service Worker is not supported in this browser');
        }
    </script>
</body>
</html>
